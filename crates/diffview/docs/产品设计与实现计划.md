# 产品设计与实现计划：基于 gpui/gpui-component 的 Git 冲突解决工具

## 目标
- 提供 JetBrains 风格的文件变更与冲突解决体验：两栏/三栏 diff、逐块采纳、冲突导航、部分暂存。
- 性能优先：大文件/多冲突场景保持流畅，滚动与行高同步准确。
- 易扩展：后续可加入评论、PR 对比、AI 辅助等。

## 功能范围
- 最小可用（MVP）
  - 文件列表：显示修改/冲突文件，过滤冲突；点击打开 diff/三方视图。
  - 视图模式：二栏 unified/split；冲突文件提供三栏 ours/base/theirs 与合并结果。
  - 冲突块操作：逐块采纳 ours/theirs/base，允许手动编辑合并结果；上一/下一冲突导航；折叠未改动上下文。
  - Git 操作：stage/unstage 文件与 hunk；revert hunk；忽略空白开关。
  - 性能：行级虚拟化；双/三栏滚动同步；异步 diff/merge 计算。
- 进阶（后续）
  - 历史/任意 commit 对比；评论；键盘驱动操作；批量冲突解决；未解决计数提示；外部修改检测与重载。

## 交互与布局（核心视图）
- 左侧：仓库文件列表 + 过滤（全部/冲突/已暂存/未暂存）；文件状态徽标。
- 主区：根据模式渲染
  - 双栏 split：左右各一滚动容器，双 gutter 行号与变更类型，内联差异高亮，工具条（忽略空白、折叠上下文、复制原/新、重置块）。
  - 单栏 inline：合并后的行流，行内添加/删除标记。
  - 三栏冲突：ours/base/theirs + 合并结果（可与 ours/theirs并列或单独结果栏），冲突块顶部显示来源，提供采纳按钮。
- 辅助：顶部摘要（冲突计数、已解决/未解决），右侧标尺标记冲突/变更，底部状态条（Git 状态、行列位置）。

## 技术架构
- 文本与 diff
  - Rope 文本模型：复用 Zed 的 buffer 或使用 `ropey`；支持增量编辑。
  - Diff/merge：`similar` 做二方 diff，三方 merge 可用 `merge`/`similar::Algorithm::Lcs` 或复用 Zed 的三方合并逻辑；支持忽略空白选项。
  - 内联差异：基于 diff 片段生成 span metadata（added/removed/unchanged/conflict-origin）。
  - 虚拟化：按可视区域+预加载行窗口渲染，缓存布局；大文件防抖 resize/reflow。
- UI 组件（gpui/gpui-component）
  - 滚动容器 + 共享 scroll model 实现双/三栏同步。
  - Gutter 组件：行号、变更标记、冲突标记；可点击跳转。
  - Diff 行组件：接受 span metadata 与样式；支持折叠上下文。
  - 工具条组件：模式切换、忽略空白、折叠、上一/下一冲突、采纳按钮。
- 状态管理
  - RepoState：工作区根、git 状态（unstaged/staged/conflicts/untracked）。
  - DiffState：当前文件的左右/三方文档、模式、忽略空白、折叠状态、滚动同步状态。
  - ConflictBlock：标识 ours/theirs/base 范围、可采纳操作、解决状态。
  - 视图偏好持久化（可选）。
- Git 集成
  - 调用 `git status --porcelain=v2`, `git diff`, `git diff --staged`, `git apply`, `git checkout --theirs/--ours`, 三方合并基于 `merge-base`；用异步任务封装。
  - 局部暂存：用 `git apply --cached` 或写补丁文件。

## 实现步骤（建议迭代）
1) 基础设施
   - 搭建 gpui 应用骨架，建立 RepoState + 异步 git service（拉取 status/diff）。
   - 引入 rope 文本模型，封装文档加载与行访问接口。
2) 二方 diff 视图（无冲突）
   - 实现 diff 计算（忽略空白开关）与 hunk 模型。
   - 构建 split 视图：双滚动容器、行虚拟化、gutter 标记、内联差异高亮、折叠上下文。
   - 内联视图：单容器流式渲染同一 hunk。
3) 冲突三方视图
   - 三方 merge 计算：生成冲突块，包含 ours/theirs/base/merged 区段。
   - 交互：逐块采纳 ours/theirs/base/混合编辑；上一/下一冲突导航；已解决计数。
   - 三栏行高/滚动同步，结果栏可编辑。
4) Git 操作集成
   - stage/unstage 文件与 hunk；revert hunk；重新加载状态。
   - 冲突解决完成后标记文件为已解决（写回合并结果并 `git add`）。
5) 性能与体验
   - 优化虚拟化窗口、布局缓存；防抖 resize；大文件流畅度测试。
   - 辅助标尺/摘要、键盘导航（可插拔命令表）。
6) 进阶能力（按需）
   - 历史/任意 commit 对比；评论；多仓库；外部修改检测与 reload。

## 技术细项与取舍
- 滚动同步：使用共享 scroll offset + 行高缓存；变更折叠时重新对齐。
- 折叠上下文：按 hunk 周围 N 行显示，可展开/收起；折叠状态存储在 DiffState。
- 语法高亮：复用 gpui rich text/Tree-sitter 管线，为 span 叠加 diff 样式。
- 键盘/命令：定义命令表（jump next conflict, accept ours/theirs, toggle whitespace）。
- 错误与安全：外部修改检测；冲突未解决时阻止保存或提示。

## 验收与测试
- 用小/中/大文件测试 diff、滚动同步、折叠、忽略空白。
- 构造冲突样例覆盖：仅 ours、仅 theirs、双改同一行、插入/删除交错。
- Git 操作回归：stage/unstage/hunk apply/revert；错误时保留缓冲区并提示。
- 性能基线：1-5 万行文件、10+ 冲突块保持流畅交互。
